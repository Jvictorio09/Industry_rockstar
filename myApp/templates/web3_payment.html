<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web3 Payment Portal | Secure USDC Payments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <!-- QR Code library for mobile connection -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 50%, #f0f0f5 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    /* Iframe embedding support */
    html, body {
      overflow-x: hidden;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .glow-effect {
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.3), 0 0 40px rgba(118, 75, 162, 0.2);
    }
    
    .pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3), 0 0 40px rgba(118, 75, 162, 0.2);
      }
      50% {
        box-shadow: 0 0 30px rgba(102, 126, 234, 0.5), 0 0 60px rgba(118, 75, 162, 0.4);
      }
    }
    
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    
    .grid-pattern {
      background-image: 
        linear-gradient(rgba(102, 126, 234, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(102, 126, 234, 0.05) 1px, transparent 1px);
      background-size: 50px 50px;
    }
    
    .crypto-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(250, 250, 255, 0.9) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
    }
    
    .crypto-card:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(245, 245, 255, 1) 100%);
      border-color: rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .input-field {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      color: #000000 !important;
      font-size: 16px;
    }
    
    .input-field::placeholder {
      color: rgba(0, 0, 0, 0.4);
      font-size: 16px;
    }
    
    .input-field:focus {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(102, 126, 234, 0.6);
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      color: #000000;
    }
    
    /* Improve text readability */
    body {
      color: #1a1a1a;
      font-size: 16px;
      line-height: 1.6;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      line-height: 1.2;
    }
    
    p, span, label {
      font-size: 16px;
      line-height: 1.6;
    }
    
    .text-sm {
      font-size: 14px !important;
    }
    
    .text-xs {
      font-size: 13px !important;
    }
    
    .text-lg {
      font-size: 18px !important;
    }
    
    .text-xl {
      font-size: 20px !important;
    }
    
    .text-2xl {
      font-size: 24px !important;
    }
    
    .text-3xl {
      font-size: 30px !important;
    }
    
    .text-4xl {
      font-size: 36px !important;
    }
    
    .text-5xl {
      font-size: 48px !important;
    }
    
    .text-6xl {
      font-size: 60px !important;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .status-connected {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .status-pending {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    
    .status-confirmed {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    /* Ensure hidden class works with Tailwind */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="grid-pattern">
  <div class="min-h-screen flex items-center justify-center py-12 px-4">
    <div class="w-full max-w-2xl">
      
      <!-- Header -->
      <div class="text-center mb-8 floating">
      <h1 class="text-5xl sm:text-6xl font-black mb-6">
        <span class="gradient-text">Web3</span>
        <span class="text-gray-900">Payment</span>
      </h1>
      <p class="text-gray-700 text-xl mb-2">Secure, decentralized payments on Base</p>
      </div>

      <!-- Main Payment Card -->
      <div class="glass-effect rounded-3xl p-8 sm:p-10 glow-effect">
        
        <!-- Wallet Connection Status -->
        <div id="wallet-status" class="mb-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Wallet Connection</h2>
            <div id="connection-badge" class="status-badge status-pending text-base">
              <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
              <span class="font-semibold text-gray-800">Not Connected</span>
            </div>
          </div>
          
          <button id="connect-btn" class="w-full btn-primary text-white py-5 rounded-xl font-bold text-lg flex items-center justify-center gap-3 pulse-glow shadow-lg">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            <span class="text-lg">Connect MetaMask</span>
          </button>
          
          <!-- QR Code Modal for Mobile -->
          <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Scan with MetaMask</h3>
                <button id="close-qr-modal" class="text-gray-500 hover:text-gray-700">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              <p class="text-gray-600 text-sm mb-4 text-center">
                Open MetaMask app and scan this QR code to connect
              </p>
              <div id="qr-code-container" class="flex justify-center mb-4 p-4 bg-white rounded-lg border-2 border-gray-200">
                <!-- QR code will be generated here -->
              </div>
              <p class="text-xs text-gray-500 text-center">
                Or tap the link below to open in MetaMask
              </p>
              <a id="metamask-deep-link" href="#" class="block mt-3 text-center text-purple-600 hover:text-purple-700 font-semibold text-sm">
                Open in MetaMask App
              </a>
            </div>
          </div>
          
          <div id="wallet-info" class="hidden mt-6 p-6 crypto-card rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-600 text-base mb-2 font-medium">Connected Wallet</p>
                <p id="wallet-address" class="text-gray-900 font-mono text-lg font-semibold"></p>
              </div>
              <div class="text-right">
                <p class="text-gray-600 text-base mb-2 font-medium">Network</p>
                <p id="network-name" class="text-gray-900 font-bold text-lg">Base</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <div id="payment-form" class="hidden">
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Select Payment Type</h2>
            
            <!-- Payment Type Selection -->
            <div class="mb-6">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <button type="button" id="course-payment-btn" class="payment-type-btn crypto-card text-gray-900 p-8 rounded-xl text-left hover:scale-105 transition-transform">
                  <div class="flex items-start justify-between mb-4">
                    <div>
                      <h3 class="text-2xl font-bold mb-2 text-gray-900">Course Payment</h3>
                      <p class="text-gray-600 text-base">Full course access</p>
                    </div>
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                  </div>
                  <div class="mt-6">
                    <p class="text-4xl font-black gradient-text mb-2">$4,995</p>
                    <p class="text-gray-600 text-base mt-2">USD • Payable in USDC</p>
                  </div>
                </button>
                
                <button type="button" id="supplier-listing-btn" class="payment-type-btn crypto-card text-gray-900 p-8 rounded-xl text-left hover:scale-105 transition-transform">
                  <div class="flex items-start justify-between mb-4">
                    <div>
                      <h3 class="text-2xl font-bold mb-2 text-gray-900">Supplier Listing</h3>
                      <p class="text-gray-600 text-base">Directory listing fee</p>
                    </div>
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                  </div>
                  <div class="mt-6">
                    <p class="text-4xl font-black gradient-text mb-2">100 USDC</p>
                    <p class="text-gray-600 text-base mt-2">Per Year</p>
                  </div>
                </button>
                
                <button type="button" id="custom-amount-btn" class="payment-type-btn crypto-card text-gray-900 p-8 rounded-xl text-left hover:scale-105 transition-transform">
                  <div class="flex items-start justify-between mb-4">
                    <div>
                      <h3 class="text-2xl font-bold mb-2 text-gray-900">Custom Amount</h3>
                      <p class="text-gray-600 text-base">Enter your amount</p>
                    </div>
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <div class="mt-6">
                    <p class="text-3xl font-black gradient-text mb-2">Custom</p>
                    <p class="text-gray-600 text-base mt-2">USDC</p>
                  </div>
                </button>
              </div>
              
              <!-- Custom Amount Input (hidden by default) -->
              <div id="custom-amount-field" class="hidden mb-4">
                <label class="block text-gray-700 text-base font-semibold mb-3">Enter Amount (USDC)*</label>
                <div class="relative">
                  <input type="number" id="custom-amount-input" min="0.01" step="0.01" placeholder="0.00"
                         class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base pr-20">
                  <span class="absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-600 font-semibold">USDC</span>
                </div>
                <p class="text-gray-500 text-sm mt-2">Minimum: 0.01 USDC</p>
              </div>
              
              <div class="mt-6 p-6 crypto-card rounded-xl">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-gray-600 text-base mb-2 font-medium">Selected Payment</p>
                    <p id="selected-payment-type" class="text-gray-900 font-bold text-lg">None selected</p>
                  </div>
                  <div class="text-right">
                    <p class="text-gray-600 text-base mb-2 font-medium">Amount</p>
                    <p id="selected-amount" class="text-gray-900 font-black text-2xl">$0.00</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Information -->
            <div class="space-y-6 mb-8">
              <h3 class="text-xl font-bold text-gray-900 mb-4">Customer Information</h3>
              
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 text-base font-semibold mb-3">First Name*</label>
                  <input type="text" id="first-name" required
                         class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base">
                </div>
                <div>
                  <label class="block text-gray-700 text-base font-semibold mb-3">Last Name*</label>
                  <input type="text" id="last-name" required
                         class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base">
                </div>
              </div>
              
              <div>
                <label class="block text-gray-700 text-base font-semibold mb-3">Email*</label>
                <input type="email" id="email" required
                       class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base">
              </div>
              
              <div>
                <label class="block text-gray-700 text-base font-semibold mb-3">Phone</label>
                <input type="tel" id="phone"
                       class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base">
              </div>
              
              <div id="supplier-fields" class="hidden">
                <label class="block text-gray-700 text-base font-semibold mb-3">Company/Business Name*</label>
                <input type="text" id="company-name"
                       class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 text-base">
              </div>
              
              <div>
                <label class="block text-gray-700 text-base font-semibold mb-3">Notes (Optional)</label>
                <textarea id="notes" rows="4"
                          class="input-field w-full px-5 py-4 rounded-xl text-gray-900 placeholder-gray-400 resize-none text-base"></textarea>
              </div>
            </div>

            <!-- Payment Button -->
            <button id="pay-btn" class="w-full btn-primary text-white py-5 rounded-xl font-bold text-xl flex items-center justify-center gap-3 shadow-lg">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="pay-btn-text" class="text-xl">Pay with USDC</span>
            </button>
          </div>
        </div>

        <!-- Transaction Status -->
        <div id="transaction-status" class="hidden">
          <div class="crypto-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-gray-900">Transaction Status</h3>
              <div id="tx-status-badge" class="status-badge status-pending">
                <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                <span class="text-gray-800">Pending</span>
              </div>
            </div>
            
            <div class="space-y-3">
              <div>
                <p class="text-gray-600 text-sm mb-1">Transaction Hash</p>
                <a id="tx-hash-link" href="#" target="_blank" class="text-gray-900 font-mono text-sm break-all hover:text-purple-600">
                  <span id="tx-hash"></span>
                </a>
              </div>
              
              <div class="flex items-center justify-between">
                <span class="text-gray-600 text-sm">Confirmations</span>
                <span class="text-gray-900 font-semibold">
                  <span id="tx-confirmations">0</span> / <span id="tx-required">2</span>
                </span>
              </div>
              
              <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden mt-4 p-4 bg-red-100 border-2 border-red-300 rounded-xl">
          <p id="error-text" class="text-red-800 text-base font-medium"></p>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-8 text-gray-600 text-base">
        <p>Powered by Base Network • Secured by Blockchain</p>
      </div>
    </div>
  </div>

<script>
  // ========== Configuration ==========
  const BASE_CHAIN_ID = 8453;
  const BASE_CHAIN_NAME = 'Base';
  const BASE_RPC_URL = 'https://mainnet.base.org';
  const BASE_EXPLORER_URL = 'https://basescan.org';
  const USDC_CONTRACT_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
  const USDC_DECIMALS = 6;
  const RECEIVER_WALLET = '0x918e03d7c59d61b6505fed486082419941ffd77f';

  const USDC_ABI = [
    {
      "constant": false,
      "inputs": [
        {"name": "to", "type": "address"},
        {"name": "amount", "type": "uint256"}
      ],
      "name": "transfer",
      "outputs": [{"name": "", "type": "bool"}],
      "type": "function"
    },
    {
      "anonymous": false,
      "inputs": [
        {"indexed": true, "name": "from", "type": "address"},
        {"indexed": true, "name": "to", "type": "address"},
        {"indexed": false, "name": "value", "type": "uint256"}
      ],
      "name": "Transfer",
      "type": "event"
    }
  ];

  // ========== State ==========
  let connectedWallet = null;
  let selectedAmount = 0;
  let selectedPaymentType = null; // 'course', 'supplier', or 'custom'
  
  // Payment configurations
  const PAYMENT_TYPES = {
    course: {
      name: 'Course Payment',
      amount: 4995,
      currency: 'USD',
      display: '$4,995 USD'
    },
    supplier: {
      name: 'Supplier Listing',
      amount: 100,
      currency: 'USDC',
      display: '100 USDC'
    },
    custom: {
      name: 'Custom Amount',
      amount: 0,
      currency: 'USDC',
      display: 'Custom USDC'
    }
  };

  // ========== UI Elements ==========
  const connectBtn = document.getElementById('connect-btn');
  const walletStatus = document.getElementById('wallet-status');
  const connectionBadge = document.getElementById('connection-badge');
  const walletInfo = document.getElementById('wallet-info');
  const walletAddress = document.getElementById('wallet-address');
  const networkName = document.getElementById('network-name');
  const paymentForm = document.getElementById('payment-form');
  const coursePaymentBtn = document.getElementById('course-payment-btn');
  const supplierListingBtn = document.getElementById('supplier-listing-btn');
  const customAmountBtn = document.getElementById('custom-amount-btn');
  const customAmountField = document.getElementById('custom-amount-field');
  const customAmountInput = document.getElementById('custom-amount-input');
  const selectedPaymentTypeEl = document.getElementById('selected-payment-type');
  const selectedAmountEl = document.getElementById('selected-amount');
  const supplierFields = document.getElementById('supplier-fields');
  const companyNameInput = document.getElementById('company-name');
  const payBtn = document.getElementById('pay-btn');
  const transactionStatus = document.getElementById('transaction-status');
  const txStatusBadge = document.getElementById('tx-status-badge');
  const txHash = document.getElementById('tx-hash');
  const txHashLink = document.getElementById('tx-hash-link');
  const txConfirmations = document.getElementById('tx-confirmations');
  const txRequired = document.getElementById('tx-required');
  const progressBar = document.getElementById('progress-bar');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');

  // ========== Helper Functions ==========
  function formatAddress(address) {
    if (!address) return '';
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
  }

  function showError(message) {
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
    setTimeout(() => errorMessage.classList.add('hidden'), 5000);
  }

  function hideError() {
    errorMessage.classList.add('hidden');
  }

  const payBtnText = document.getElementById('pay-btn-text');
  
  function selectPaymentType(type) {
    selectedPaymentType = type;
    const payment = PAYMENT_TYPES[type];
    
    // Reset all button states
    coursePaymentBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
    coursePaymentBtn.classList.add('crypto-card');
    supplierListingBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
    supplierListingBtn.classList.add('crypto-card');
    customAmountBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
    customAmountBtn.classList.add('crypto-card');
    
    // Hide/show fields
    supplierFields.classList.add('hidden');
    companyNameInput.removeAttribute('required');
    customAmountField.classList.add('hidden');
    customAmountInput.removeAttribute('required');
    
    if (type === 'course') {
      selectedAmount = payment.amount;
      selectedPaymentTypeEl.textContent = payment.name;
      selectedAmountEl.textContent = payment.display;
      payBtnText.textContent = `Pay $4,995 USDC`;
      
      coursePaymentBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      coursePaymentBtn.classList.remove('crypto-card');
    } else if (type === 'supplier') {
      selectedAmount = payment.amount;
      selectedPaymentTypeEl.textContent = payment.name;
      selectedAmountEl.textContent = payment.display;
      payBtnText.textContent = `Pay 100 USDC`;
      
      supplierListingBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      supplierListingBtn.classList.remove('crypto-card');
      supplierFields.classList.remove('hidden');
      companyNameInput.setAttribute('required', 'required');
    } else if (type === 'custom') {
      selectedAmount = 0; // Will be set from input
      selectedPaymentTypeEl.textContent = payment.name;
      selectedAmountEl.textContent = 'Enter amount below';
      payBtnText.textContent = `Pay USDC`;
      
      customAmountBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
      customAmountBtn.classList.remove('crypto-card');
      customAmountField.classList.remove('hidden');
      customAmountInput.setAttribute('required', 'required');
      customAmountInput.focus();
    }
  }
  
  // Update custom amount when input changes
  if (customAmountInput) {
    customAmountInput.addEventListener('input', (e) => {
      if (selectedPaymentType === 'custom') {
        const value = parseFloat(e.target.value);
        if (!isNaN(value) && value > 0) {
          selectedAmount = value;
          selectedAmountEl.textContent = `${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USDC`;
          payBtnText.textContent = `Pay ${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USDC`;
        } else {
          selectedAmount = 0;
          selectedAmountEl.textContent = 'Enter amount below';
          payBtnText.textContent = `Pay USDC`;
        }
      }
    });
  }

  // ========== MetaMask Functions ==========
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  function attemptMobileDeepLink() {
    // Try to open MetaMask app via deep link
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    if (isIOS) {
      // iOS: Try MetaMask deep link, fallback to App Store
      const metamaskUrl = 'metamask://wc?uri=' + encodeURIComponent(window.location.href);
      const appStoreUrl = 'https://apps.apple.com/app/metamask/id1438144202';
      
      // Try deep link first
      window.location.href = metamaskUrl;
      
      // If deep link fails, show instructions
      setTimeout(() => {
        const useBrowser = confirm(
          'To connect MetaMask on mobile:\n\n' +
          'Option 1: Open in MetaMask Browser\n' +
          '• Open MetaMask app\n' +
          '• Tap menu (☰) → Browser\n' +
          '• Navigate to this page\n\n' +
          'Option 2: Use WalletConnect\n' +
          '• Install MetaMask if needed\n' +
          '• This page will connect automatically\n\n' +
          'Click OK to open MetaMask in App Store, or Cancel to try again.'
        );
        if (useBrowser) {
          window.open(appStoreUrl, '_blank');
        }
      }, 1000);
      
      showError('Opening MetaMask app... If it doesn\'t open, please use MetaMask mobile browser (menu → Browser).');
      return null;
    } else if (isAndroid) {
      // Android: Try MetaMask deep link, fallback to Play Store
      const metamaskUrl = 'metamask://wc?uri=' + encodeURIComponent(window.location.href);
      const playStoreUrl = 'https://play.google.com/store/apps/details?id=io.metamask';
      
      // Try deep link first
      window.location.href = metamaskUrl;
      
      // If deep link fails, show instructions
      setTimeout(() => {
        const useBrowser = confirm(
          'To connect MetaMask on mobile:\n\n' +
          'Option 1: Open in MetaMask Browser\n' +
          '• Open MetaMask app\n' +
          '• Tap menu (☰) → Browser\n' +
          '• Navigate to this page\n\n' +
          'Option 2: Use WalletConnect\n' +
          '• Install MetaMask if needed\n' +
          '• This page will connect automatically\n\n' +
          'Click OK to open MetaMask in Play Store, or Cancel to try again.'
        );
        if (useBrowser) {
          window.open(playStoreUrl, '_blank');
        }
      }, 1000);
      
      showError('Opening MetaMask app... If it doesn\'t open, please use MetaMask mobile browser (menu → Browser).');
      return null;
    }
    
    // Fallback for other mobile devices
    showError('Please open this page in MetaMask mobile browser. In MetaMask app, tap menu (☰) → Browser, then navigate here.');
    return null;
  }

  function isMetaMaskInstalled() {
    // On mobile, MetaMask is an app, not a browser extension
    // So we check differently - try to detect if MetaMask mobile browser is being used
    // or if window.ethereum is available (which can happen on mobile browsers that support it)
    if (isMobileDevice()) {
      // On mobile, we'll try to connect anyway
      // MetaMask mobile can inject ethereum provider in some browsers
      // Or we can use WalletConnect/deep linking
      return typeof window.ethereum !== 'undefined' || true; // Allow connection attempt on mobile
    }
    // Desktop: check for extension
    return typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask;
  }

  async function showQRCodeModal() {
    const qrModal = document.getElementById('qr-modal');
    const qrContainer = document.getElementById('qr-code-container');
    const deepLink = document.getElementById('metamask-deep-link');
    
    // Get current page URL
    const currentUrl = window.location.href;
    
    // Generate QR code
    qrContainer.innerHTML = ''; // Clear previous QR code
    QRCode.toCanvas(qrContainer, currentUrl, {
      width: 256,
      margin: 2,
      color: {
        dark: '#000000',
        light: '#FFFFFF'
      }
    }, function (error) {
      if (error) {
        console.error('QR code generation error:', error);
        qrContainer.innerHTML = '<p class="text-red-500 text-sm">Failed to generate QR code</p>';
      }
    });
    
    // Set up deep link
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    if (isIOS) {
      deepLink.href = `metamask://wc?uri=${encodeURIComponent(currentUrl)}`;
    } else if (isAndroid) {
      deepLink.href = `metamask://wc?uri=${encodeURIComponent(currentUrl)}`;
    } else {
      deepLink.href = currentUrl;
    }
    
    // Show modal
    qrModal.classList.remove('hidden');
    
    // Close modal handlers
    document.getElementById('close-qr-modal').onclick = () => {
      qrModal.classList.add('hidden');
    };
    
    qrModal.onclick = (e) => {
      if (e.target === qrModal) {
        qrModal.classList.add('hidden');
      }
    };
  }

  async function connectMetaMask() {
    const isMobile = isMobileDevice();
    
    // On mobile, try to connect - MetaMask mobile browser injects provider
    if (isMobile) {
      // Always try to connect first - don't check if provider exists
      // This allows connection if user is in MetaMask mobile browser
      try {
        if (typeof window.ethereum !== 'undefined') {
          // Provider available - try to connect
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
          });
          
          if (accounts.length === 0) {
            showError('No accounts found. Please create or import an account in MetaMask.');
            return null;
          }
          
          return accounts[0];
        } else {
          // No provider - show QR code modal for easy connection
          showQRCodeModal();
          return null;
        }
      } catch (error) {
        console.error('Mobile MetaMask connection error:', error);
        if (error.code === 4001) {
          showError('Connection rejected. Please approve the connection in MetaMask.');
        } else if (error.code === -32002) {
          showError('Connection request already pending. Please check MetaMask.');
        } else {
          // Show QR code as fallback
          showQRCodeModal();
        }
        return null;
      }
    }
    
    // Desktop: Check if MetaMask extension is installed
    if (!isMetaMaskInstalled()) {
      const installConfirm = confirm(
        'MetaMask is not installed. Would you like to install it?\n\n' +
        'Click OK to open the download page in a new tab, or Cancel to stay here.'
      );
      if (installConfirm) {
        window.open('https://metamask.io/download/', '_blank');
      } else {
        showError('MetaMask is required to make payments. Please install MetaMask and refresh this page.');
      }
      return null;
    }

    // Desktop: Connect to MetaMask extension
    try {
      console.log('Requesting MetaMask accounts...');
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      });

      console.log('MetaMask accounts:', accounts);

      if (accounts.length === 0) {
        showError('No accounts found in MetaMask. Please create or import an account.');
        return null;
      }

      return accounts[0];
    } catch (error) {
      console.error('Error connecting to MetaMask:', error);
      if (error.code === 4001) {
        showError('Connection rejected. Please approve the connection in MetaMask to continue.');
      } else if (error.code === -32002) {
        showError('A connection request is already pending. Please check your MetaMask extension.');
      } else {
        showError('Failed to connect to MetaMask: ' + (error.message || 'Unknown error'));
      }
      return null;
    }
  }

  async function getNetwork() {
    try {
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });
      return parseInt(chainId, 16);
    } catch (error) {
      console.error('Error getting network:', error);
      return null;
    }
  }

  async function switchToBase() {
    try {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: `0x${BASE_CHAIN_ID.toString(16)}` }],
      });
      return true;
    } catch (switchError) {
      if (switchError.code === 4902) {
        try {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: `0x${BASE_CHAIN_ID.toString(16)}`,
              chainName: BASE_CHAIN_NAME,
              nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
              },
              rpcUrls: [BASE_RPC_URL],
              blockExplorerUrls: [BASE_EXPLORER_URL]
            }],
          });
          return true;
        } catch (addError) {
          console.error('Error adding Base network:', addError);
          showError('Failed to add Base network to MetaMask');
          return false;
        }
      } else {
        console.error('Error switching network:', switchError);
        showError('Failed to switch to Base network');
        return false;
      }
    }
  }

  async function ensureBaseNetwork() {
    const currentNetwork = await getNetwork();
    if (currentNetwork !== BASE_CHAIN_ID) {
      const switched = await switchToBase();
      if (!switched) {
        return false;
      }
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    return true;
  }

  function usdcToRaw(usdcAmount) {
    return ethers.utils.parseUnits(usdcAmount.toString(), USDC_DECIMALS);
  }

  // ========== Transaction Functions ==========
  async function sendUSDCTransfer(amountUSDC, customerInfo) {
    try {
      const onBase = await ensureBaseNetwork();
      if (!onBase) {
        return { success: false, error: 'Please switch to Base network' };
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, USDC_ABI, signer);
      const amountRaw = usdcToRaw(amountUSDC);

      let gasEstimate;
      try {
        gasEstimate = await usdcContract.estimateGas.transfer(RECEIVER_WALLET, amountRaw);
      } catch (error) {
        console.error('Gas estimation failed:', error);
        gasEstimate = ethers.BigNumber.from('100000');
      }

      const tx = await usdcContract.transfer(RECEIVER_WALLET, amountRaw, {
        gasLimit: gasEstimate.mul(120).div(100),
      });

      console.log('Transaction sent:', tx.hash);

      const verifyResponse = await fetch('/api/crypto/verify-transaction/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          transaction_hash: tx.hash,
          amount_usdc: amountUSDC,
          from_address: connectedWallet,
          ...customerInfo,
        }),
      });

      const verifyData = await verifyResponse.json();

      if (!verifyData.success) {
        return { success: false, error: verifyData.error };
      }

      return {
        success: true,
        transaction_hash: tx.hash,
        payment_id: verifyData.payment_id,
        confirmations: verifyData.confirmations,
        required_confirmations: verifyData.required_confirmations,
      };

    } catch (error) {
      console.error('Error sending USDC transfer:', error);
      if (error.code === 4001) {
        return { success: false, error: 'Transaction rejected by user' };
      } else if (error.code === -32603) {
        return { success: false, error: 'Insufficient USDC balance or gas' };
      } else {
        return { success: false, error: error.message || 'Transaction failed' };
      }
    }
  }

  async function checkPaymentStatus(txHash) {
    try {
      const response = await fetch(`/api/crypto/payment-status/${txHash}/`);
      if (!response.ok) {
        return null;
      }
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Error checking payment status:', error);
      return null;
    }
  }

  async function waitForConfirmation(txHash, onUpdate) {
    const maxAttempts = 120;
    let attempts = 0;

    const poll = async () => {
      attempts++;
      const status = await checkPaymentStatus(txHash);

      if (status) {
        onUpdate(status);

        if (status.status === 'confirmed') {
            txStatusBadge.className = 'status-badge status-confirmed';
            txStatusBadge.innerHTML = '<div class="w-2 h-2 bg-green-400 rounded-full"></div><span>Confirmed</span>';
            progressBar.style.width = '100%';
          setTimeout(() => {
            window.location.href = `/payment/success/?tx=${txHash}`;
          }, 2000);
          return true;
        }

        if (status.status === 'failed') {
          txStatusBadge.className = 'status-badge';
          txStatusBadge.innerHTML = '<div class="w-2 h-2 bg-red-400 rounded-full"></div><span>Failed</span>';
          showError('Transaction failed');
          return false;
        }
      }

      if (attempts >= maxAttempts) {
        showError('Transaction confirmation timeout');
        return false;
      }

      setTimeout(poll, 5000);
    };

    poll();
  }

  // ========== Event Handlers ==========
  connectBtn.addEventListener('click', async (e) => {
    e.preventDefault(); // Prevent any default behavior or redirects
    console.log('Connect button clicked');
    hideError();
    connectBtn.disabled = true;
    connectBtn.innerHTML = '<span>Connecting...</span>';

    try {
      // On mobile, try to connect even if provider not detected
      // MetaMask mobile browser will inject the provider
      const isMobile = isMobileDevice();
      if (isMobile && typeof window.ethereum === 'undefined') {
        // Show helpful message but still try to connect
        console.log('Mobile device detected, attempting connection...');
      }
      
      const account = await connectMetaMask();
      console.log('Connected account:', account);
      
      if (account) {
        connectedWallet = account;
        walletAddress.textContent = formatAddress(account);
        networkName.textContent = 'Base';
        
        connectionBadge.className = 'status-badge status-connected';
        connectionBadge.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="font-semibold text-gray-800">Connected</span>';
        
        walletInfo.classList.remove('hidden');
        connectBtn.classList.add('hidden');
        
        // Show payment form - force display
        paymentForm.classList.remove('hidden');
        paymentForm.style.display = 'block';
        console.log('Payment form should be visible now');

        // Check network
        const network = await getNetwork();
        if (network !== BASE_CHAIN_ID) {
          showError('Please switch to Base network in MetaMask');
        }
      } else {
        console.log('Failed to connect account');
      }
    } catch (error) {
      console.error('Error in connect button handler:', error);
      showError('Error connecting: ' + error.message);
    } finally {
      connectBtn.disabled = false;
      if (!connectedWallet) {
        connectBtn.innerHTML = '<svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg><span class="text-lg">Connect MetaMask</span>';
      }
    }
  });

  // Payment type selection
  coursePaymentBtn.addEventListener('click', () => {
    selectPaymentType('course');
  });

  supplierListingBtn.addEventListener('click', () => {
    selectPaymentType('supplier');
  });
  
  customAmountBtn.addEventListener('click', () => {
    selectPaymentType('custom');
  });

  // Payment button
  payBtn.addEventListener('click', async () => {
    if (!selectedPaymentType) {
      showError('Please select a payment type');
      return;
    }

    if (selectedAmount <= 0) {
      if (selectedPaymentType === 'custom') {
        showError('Please enter a valid custom amount (minimum 0.01 USDC)');
      } else {
        showError('Please select a payment type');
      }
      return;
    }
    
    // Validate custom amount
    if (selectedPaymentType === 'custom') {
      const customValue = parseFloat(customAmountInput.value);
      if (isNaN(customValue) || customValue < 0.01) {
        showError('Please enter a valid amount (minimum 0.01 USDC)');
        customAmountInput.focus();
        return;
      }
      selectedAmount = customValue;
    }

    if (!connectedWallet) {
      showError('Please connect your MetaMask wallet first');
      return;
    }

    const firstName = document.getElementById('first-name').value;
    const lastName = document.getElementById('last-name').value;
    const email = document.getElementById('email').value;

    if (!firstName || !lastName || !email) {
      showError('Please fill in all required fields');
      return;
    }

    // Validate supplier-specific fields
    if (selectedPaymentType === 'supplier') {
      const companyName = document.getElementById('company-name').value;
      if (!companyName) {
        showError('Please enter your company/business name');
        return;
      }
    }

    // For course payment, convert USD to USDC (1:1 for USDC stablecoin)
    const amountUSDC = selectedPaymentType === 'course' ? selectedAmount : selectedAmount;

    const customerInfo = {
      first_name: firstName,
      last_name: lastName,
      email: email,
      mobile: document.getElementById('phone').value,
      message: document.getElementById('notes').value,
      company_name: selectedPaymentType === 'supplier' ? document.getElementById('company-name').value : '',
      payment_type: selectedPaymentType,
      org: 'tanya-client',
      frequency: 'one_time',
    };

    payBtn.disabled = true;
    payBtn.textContent = 'Processing...';

    try {
      const result = await sendUSDCTransfer(amountUSDC, customerInfo);

      if (result.success) {
        paymentForm.classList.add('hidden');
        transactionStatus.classList.remove('hidden');
        txHash.textContent = result.transaction_hash;
        txHashLink.href = `https://basescan.org/tx/${result.transaction_hash}`;
        txConfirmations.textContent = result.confirmations;
        txRequired.textContent = result.required_confirmations;
        
        const progress = (result.confirmations / result.required_confirmations) * 100;
        progressBar.style.width = `${Math.min(progress, 100)}%`;

        waitForConfirmation(result.transaction_hash, (status) => {
          txConfirmations.textContent = status.confirmations;
          txRequired.textContent = status.required_confirmations;
          const progress = (status.confirmations / status.required_confirmations) * 100;
          progressBar.style.width = `${Math.min(progress, 100)}%`;
        });
      } else {
        showError('Payment failed: ' + result.error);
        payBtn.disabled = false;
        payBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Pay with USDC';
      }
    } catch (error) {
      showError('Error: ' + error.message);
      payBtn.disabled = false;
      payBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Pay with USDC';
    }
  });

  // Auto-check for existing connection on page load
  async function checkExistingConnection() {
    if (!isMetaMaskInstalled()) {
      console.log('MetaMask not installed');
      return;
    }

    try {
      // Check if already connected
      const accounts = await window.ethereum.request({
        method: 'eth_accounts'
      });

      console.log('Existing accounts:', accounts);

      if (accounts.length > 0) {
        // Already connected - update UI
        connectedWallet = accounts[0];
        walletAddress.textContent = formatAddress(connectedWallet);
        networkName.textContent = 'Base';
        
        connectionBadge.className = 'status-badge status-connected';
        connectionBadge.innerHTML = '<div class="w-2 h-2 bg-green-400 rounded-full"></div><span>Connected</span>';
        
        walletInfo.classList.remove('hidden');
        connectBtn.classList.add('hidden');
        paymentForm.classList.remove('hidden');
        paymentForm.style.display = 'block';
        
        console.log('Form should be visible now');
        
        // Force show after a moment
        setTimeout(() => {
          paymentForm.classList.remove('hidden');
          paymentForm.style.display = 'block';
        }, 100);

        // Check network
        const network = await getNetwork();
        if (network !== BASE_CHAIN_ID) {
          showError('Please switch to Base network');
        }
      } else {
        console.log('No existing connection found');
      }
    } catch (error) {
      console.error('Error checking existing connection:', error);
      showError('Error checking wallet connection: ' + error.message);
    }
  }

  // Check on page load
  window.addEventListener('load', () => {
    console.log('Page loaded, checking connection...');
    checkExistingConnection();
  });
  
  // Also check when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkExistingConnection);
  } else {
    checkExistingConnection();
  }

  // Listen for network changes
  if (window.ethereum) {
    window.ethereum.on('chainChanged', (chainId) => {
      const networkId = parseInt(chainId, 16);
      if (networkId !== BASE_CHAIN_ID && connectedWallet) {
        showError('Please switch to Base network');
      } else {
        hideError();
      }
    });

    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        connectedWallet = null;
        walletInfo.classList.add('hidden');
        paymentForm.classList.add('hidden');
        connectBtn.classList.remove('hidden');
        connectionBadge.className = 'status-badge status-pending';
        connectionBadge.innerHTML = '<div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div><span>Not Connected</span>';
      } else {
        connectedWallet = accounts[0];
        walletAddress.textContent = formatAddress(connectedWallet);
        // Auto-update UI if already connected
        if (!paymentForm.classList.contains('hidden')) {
          connectionBadge.className = 'status-badge status-connected';
          connectionBadge.innerHTML = '<div class="w-2 h-2 bg-green-400 rounded-full"></div><span>Connected</span>';
        }
      }
    });
  }
  
  // ========== Iframe Embedding Support ==========
  // Send height updates to parent iframe
  function sendHeightToParent() {
    if (window.parent !== window) {
      const height = Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight,
        document.documentElement.offsetHeight,
        document.body.offsetHeight,
        document.documentElement.clientHeight
      );
      window.parent.postMessage(
        { type: 'web3-payment-height', height: Math.ceil(height) },
        '*'
      );
    }
  }
  
  // Send height on load and when content changes
  window.addEventListener('load', () => {
    sendHeightToParent();
    // Send height updates periodically and on resize
    setInterval(sendHeightToParent, 500);
  });
  
  window.addEventListener('resize', sendHeightToParent);
  
  // Send height when form visibility changes
  const observer = new MutationObserver(() => {
    sendHeightToParent();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['class', 'style']
  });
  
  // Also send height when payment form is shown/hidden
  const originalToggle = paymentForm.classList.toggle;
  paymentForm.addEventListener('transitionend', sendHeightToParent);
</script>

</body>
</html>


